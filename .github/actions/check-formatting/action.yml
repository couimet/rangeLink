name: 'Check Formatting and Linting'
description: 'Run format check, linting, and type checking'

inputs:
  skip-format:
    description: 'Skip format checking'
    required: false
    default: 'false'
  skip-lint:
    description: 'Skip linting'
    required: false
    default: 'false'
  skip-types:
    description: 'Skip type checking'
    required: false
    default: 'false'
  allow-format-failure:
    description: 'Allow format check to fail without blocking CI'
    required: false
    default: 'false'
  allow-lint-failure:
    description: 'Allow linting to fail without blocking CI'
    required: false
    default: 'false'
  lint-changed-only:
    description: 'Only lint files changed in the PR (strict mode on changed files)'
    required: false
    default: 'false'
  base-ref:
    description: 'Base branch for changed file comparison (default: main)'
    required: false
    default: 'main'
  allow-types-failure:
    description: 'Allow type checking to fail without blocking CI'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Check formatting with Prettier
      if: inputs.skip-format != 'true'
      shell: bash
      run: |
        echo "Running format check..."
        if ! pnpm format; then
          if [ "${{ inputs.allow-format-failure }}" = "true" ]; then
            echo "::warning::Format check found issues (allowed to fail)"
          else
            exit 1
          fi
        fi

    - name: Run ESLint (changed files only)
      if: inputs.skip-lint != 'true' && inputs.lint-changed-only == 'true'
      shell: bash
      env:
        BASE_REF: ${{ inputs.base-ref }}
      run: |
        echo "Running linter on changed files only (strict mode)..."
        CHANGED_FILES=$(git diff --name-only --diff-filter=d origin/${BASE_REF}...HEAD -- '*.ts' '*.tsx' || true)
        if [ -z "$CHANGED_FILES" ]; then
          echo "No TypeScript files changed - skipping lint"
        else
          echo "Linting changed files:"
          echo "$CHANGED_FILES"
          echo "$CHANGED_FILES" | xargs pnpm eslint
        fi

    - name: Run ESLint (all files)
      if: inputs.skip-lint != 'true' && inputs.lint-changed-only != 'true'
      shell: bash
      run: |
        echo "Running linter on all files..."
        if ! pnpm lint; then
          if [ "${{ inputs.allow-lint-failure }}" = "true" ]; then
            echo "::warning::Linting found issues (allowed to fail)"
          else
            exit 1
          fi
        fi

    - name: Type check with TypeScript
      if: inputs.skip-types != 'true'
      shell: bash
      run: |
        echo "Running type check..."
        if ! pnpm compile; then
          if [ "${{ inputs.allow-types-failure }}" = "true" ]; then
            echo "::warning::Type checking found issues (allowed to fail)"
          else
            exit 1
          fi
        fi
